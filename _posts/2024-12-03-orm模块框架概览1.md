---
title: ORM模块：框架概览（一）
date: 2024-12-04 10:00:00 +0800
categories: [go进阶之orm模块, 框架概览]
tags: [orm, 数据库, go进阶, sql]  # TAG names should always be lowercase
description: 介绍 beego orm 框架
toc: true          # 可选，开启或关闭目录（取决于你的主题是否支持）
---
# ORM 模块：框架概览（一）
## ORM框架解决了什么问题？
  在没有 ORM 框架的时候，我们需要：
- 手写 SQL：
  - 容易出错
  - 难以重构
- 手动处理结果集：
  - 样板代码满天飞
  - 精力都花在了跟业务没关系的地方
 
为了解决上面的问题，就有了ORM框架。

## Beego ORM —— 入门例子
初始化分三个步骤：1.注册模型，2.注册驱动，3.注册数据库

```cgo
type User struct {
	ID   int    `orm:"column(id)"`
	Name string `orm:"column(name)"`
}

func init() {
	// 1 need to register models in init
	orm.RegisterModel(new(User))

	// 2 need to register db driver
	orm.RegisterDriver("sqlite3", orm.DRSqlite)

	// 3 need to register default database
	orm.RegisterDataBase("default",
		"sqlite3", "beego.db")
}

```
使用时需要创建orm实例
```cgo
func TestCRUD(t *testing.T) {
	// automatically build table
	orm.RunSyncdb("default", false, true)

	// create orm object
	o := orm.NewOrm()

	// data
	user := new(User)
	user.Name = "mike"

	// insert data
	o.Insert(user)
}
```

## Beego ORM —— 元数据
元数据是对模型的描述，在 Beego 里面分成
modelInfo -> fields -> fieldInfo 三个层级
- modelInfo：负责描述和管理整个模型的元数据
```cgo
// single model info
type modelInfo struct {
	manual    bool  // 表示是否是手动定义的模型
	isThrough bool  // 表示模型是否是 "中间表"（through table）
	pkg       string // 存储模型所在的包路径
	name      string // 模型的名称
	fullName  string // 模型的全名
	table     string // 数据库中对应的表名
	model     interface{} // 保存具体的模型实例
	fields    *fields // 指向一个 fields 类型的指针，存储模型中字段的详细信息
	addrField reflect.Value // 使用 reflect.Value 存储原始结构体的地址
	uniques   []string // 保存模型中唯一字段
}
```
- fields: 负责高效管理字段集合，提供按功能分类的能力
```cgo
// field info collection
type fields struct {
	pk            *fieldInfo // 主键字段的元信息
	columns       map[string]*fieldInfo // 按数据库列名组织的字段信息
	fields        map[string]*fieldInfo // 按结构体字段名组织的字段信息
	fieldsLow     map[string]*fieldInfo // 存储字段信息，但键名被转换为小写
	fieldsByType  map[int][]*fieldInfo  // 按字段类型组织的字段信息
	fieldsRel     []*fieldInfo // 存储与其他模型关联的字段信息（关系字段）
	fieldsReverse []*fieldInfo // 存储反向关联的字段信息
	fieldsDB      []*fieldInfo // 存储与数据库直接映射的字段信息
	rels          []*fieldInfo // 存储所有关系字段
	orders        []string // 按字段顺序存储字段名列表。
	dbcols        []string // 按顺序存储数据库列名的列表。
}

```
- fieldInfo: 负责单个字段的详细描述，包括字段的数据库映射和行为定义。
```cgo
// single field info
// 这里只展示了元数据相关的内容
type fieldInfo struct {
  ...
	mi              *modelInfo // 该字段所属的模型信息
	fieldIndex      []int // 表示字段在结构体中的位置（嵌套结构体的索引）
	fieldType       int // 字段类型的枚举值（如字符串、整型、时间类型）
	name            string // 结构体中的字段名
	fullName        string // 字段的全名，通常包括包路径
	column          string // 数据库中对应的列名
	addrValue       reflect.Value // 该字段的地址值，用于动态操作
	sf              reflect.StructField // 字段的结构体元信息，用于反射操作
	initial         StrTo // 用于存储字段的默认值
	size            int // 字段的最大长度（如字符串长度限制）
  ...
}
```
 **总结**：这三个结构体 (modelInfo, fields, fieldInfo) 代表了一个从高到低的层次化抽象，分别描述了模型、字段集合和单个字段的信息。

## Beego ORM —— 查询接口

## Beego ORM —— 数据接口
